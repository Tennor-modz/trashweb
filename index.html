6 chars'); return; }
    if(users.find(u => u.username === username)){ alert('Username exists'); return; }
    users.push({ username, email, password });
    localStorage.setItem('users', JSON.stringify(users));
    alert('Account created! Please login.');
    showLogin();
  }

  function login(){
    const username = document.getElementById('loginUsername').value.trim();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const user = users.find(u => u.username === username && u.email === email && u.password === password);
    if(user){
      localStorage.setItem('loggedInUser', username);
      document.body.classList.add('logged-in');
      showMainContent();
    } else {
      alert('Invalid credentials.');
    }
  }

  function logout(){
    localStorage.removeItem('loggedInUser');
    document.body.classList.remove('logged-in');
    document.getElementById('mainContent').classList.add('hidden');
    document.getElementById('menu').classList.add('hidden');
    showLogin();
  }

  function showMainContent(){
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('menu').classList.remove('hidden');
    showPublicMessages();
  }

  function showLogin(){
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
  }

  function showSignup(){
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('signupForm').classList.remove('hidden');
  }

  // --- Hamburger Menu ---
  const menuBtn = document.getElementById('menuBtn');
  const dropdown = document.getElementById('dropdownMenu');
  menuBtn.addEventListener('click', () => {
    dropdown.classList.toggle('show');
    menuBtn.classList.toggle('open');
  });
  window.addEventListener('click', e => {
    if(!e.target.closest('.menu-btn')){
      dropdown.classList.remove('show');
      menuBtn.classList.remove('open');
    }
  });

  // --- Public Chat ---
  function sendPublicMessage(){
    const text = document.getElementById('publicInput').value.trim();
    if(!text) return;
    const from = localStorage.getItem('loggedInUser') || 'Guest';
    publicMessages.push({ from, text, time: new Date().toLocaleTimeString() });
    localStorage.setItem('publicMessages', JSON.stringify(publicMessages));
    document.getElementById('publicInput').value = '';
    showPublicMessages();
  }

  function showPublicMessages(){
    const box = document.getElementById('publicMessages');
    box.innerHTML = '';
    publicMessages.forEach(m => {
      const p = document.createElement('p');
      p.textContent = `[${m.time}] ${m.from}: ${m.text}`;
      box.appendChild(p);
    });
    box.scrollTop = box.scrollHeight;
  }

  window.addEventListener('storage', e => {
    if(e.key === 'publicMessages'){
      publicMessages = JSON.parse(e.newValue) || [];
      showPublicMessages();
    }
  });

  // --- YouTube Music Search & Download ---
  async function searchSong(){
    const query = document.getElementById('songQuery').value.trim();
    if(!query){ alert('Enter a song name or YouTube link'); return; }
    const resultsDiv = document.getElementById('songResults');
    resultsDiv.innerHTML = '<p>Searching...</p>';
    try{
      const response = await fetch(`http://localhost:3000/api/searchYoutube?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      resultsDiv.innerHTML = '';
      if(data.length === 0){ resultsDiv.innerHTML = '<p>No results found.</p>'; return; }

      const ul = document.createElement('ul');
      data.forEach(video => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${video.title} (${video.duration})</span>
          <span>
            <a href="http://localhost:3000/api/download?videoId=${video.videoId}&type=video" title="Download Video"><i class="fas fa-video"></i></a>
            <a href="http://localhost:3000/api/download?videoId=${video.videoId}&type=audio" title="Download Audio"><i class="fas fa-file-audio"></i></a>
          </span>
        `;
        ul.appendChild(li);
      });
      resultsDiv.appendChild(ul);
    } catch(err){
      console.error(err);
      resultsDiv.innerHTML = '<p>Error fetching videos.</p>';
    }
  }

  // --- PWA Install Banner ---
  let deferredPrompt;
  const installBanner = document.getElementById('installBanner');
  const installBtn = document.getElementById('installBtn');
  const dismissBtn = document.getElementById('dismissInstall');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if(/Mobi|Android/i.test(navigator.userAgent)){ installBanner.style.display = 'block'; }
  });

  installBtn.addEventListener('click', async () => {
    installBanner.style.display = 'none';
    if(deferredPrompt){
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('User choice:', outcome);
      deferredPrompt = null;
    }
  });

  dismissBtn.addEventListener('click', () => { installBanner.style.display = 'none'; });

  // --- Service Worker ---
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>{ console.log('Service Worker registered'); });
  }

</script>
</body>
</html>
