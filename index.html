<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trashcore Multi-User Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body { font-family: Arial,sans-serif; margin:0; padding:0; text-align:center;
         background: linear-gradient(135deg, #1E90FF 0%, #32CD32 100%);
         min-height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column; position: relative;
         transition: background 0.5s ease; }
  body.logged-in { background:#000; color:white; }

  .hidden { display:none; }
  .form-container, .card-container, .card { background:#1E90FF; padding:30px; border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.15); color:white; max-width:450px; width:100%; margin:10px; }

  body.logged-in .card-container, body.logged-in .card { background:#111; }

  h1 { margin-bottom:20px; }
  input, select { width:90%; padding:10px; margin:8px 0; border-radius:6px; border:none; }
  button { width:95%; padding:12px; margin:8px 0; border-radius:8px; border:none; background-color:#32CD32;
           color:white; font-weight:bold; cursor:pointer; transition:0.3s; }
  button:hover { background-color:#28a428; }
  .toggle-form { background:none; color:yellow; border:none; cursor:pointer; text-decoration:underline; margin-top:5px; }

  /* Chat Room */
  #chatMessages { height:250px; overflow-y:auto; background:#222; padding:10px; border-radius:8px; margin-bottom:10px; text-align:left; }
  .chatMessage { padding:5px 10px; margin-bottom:6px; border-radius:8px; max-width:80%; display:inline-block; word-wrap:break-word; }
  .chatMessage.sent { background:#32CD32; color:#000; text-align:right; float:right; clear:both; }
  .chatMessage.received { background:#FF4500; color:#fff; text-align:left; float:left; clear:both; }
  .timestamp { font-size:10px; color:#ccc; margin-left:5px; }

  .logout-btn { background-color:#FF4500; margin-top:10px; }
  .logout-btn:hover { background-color:#e03e00; }

  .copyright { margin:20px 0; font-size:14px; }
</style>
</head>
<body>

<!-- Sign Up Form -->
<div class="form-container" id="signupForm">
  <h1>Sign Up</h1>
  <input type="text" id="signupUsername" placeholder="Username (3-15 letters/numbers/_)" required>
  <input type="email" id="signupEmail" placeholder="Email" required>
  <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required>
  <button onclick="signup()">Create Account</button>
  <button class="toggle-form" onclick="showLogin()">Already have an account? Login</button>
</div>

<!-- Login Form -->
<div class="form-container hidden" id="loginForm">
  <h1>Login</h1>
  <input type="text" id="loginUsername" placeholder="Username" required>
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button onclick="login()">Login</button>
  <button class="toggle-form" onclick="showSignup()">Don't have an account? Sign Up</button>
</div>

<!-- Main Content -->
<div class="card-container hidden" id="mainContent">
  <h1>TRASHCORE SERVICES</h1>
  <div class="card">
    <h2>Multi-User Private Chat</h2>
    <select id="chatRecipient" onchange="showChatMessages()">
      <option value="">Select a user...</option>
    </select>
    <div id="chatMessages"></div>
    <input type="text" id="chatInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="copyright">
  ©️ 2023-202?? by Trashcore Devs
</div>

<script>
// Users & Messages
let users = JSON.parse(localStorage.getItem('users')) || [];
let messages = JSON.parse(localStorage.getItem('messages')) || [];

// Check login
if(localStorage.getItem('loggedInUser')) {
  document.body.classList.add('logged-in'); 
  showMainContent(); 
  populateRecipients();
  showChatMessages();
}

// Validation
function isValidUsername(name){ return /^[a-zA-Z0-9_]{3,15}$/.test(name); }
function isValidPassword(pw){ return pw.length >=6; }

// Signup/Login
function signup() {
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  if(!username||!email||!password){ alert('Fill all fields'); return; }
  if(!isValidUsername(username)){ alert('Invalid username'); return; }
  if(!isValidPassword(password)){ alert('Password min 6 chars'); return; }
  if(users.find(u=>u.username===username)){ alert('Username exists'); return; }
  users.push({username,email,password});
  localStorage.setItem('users',JSON.stringify(users));
  alert('Account created! Please login.');
  showLogin();
}

function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const user = users.find(u=>u.username===username && u.email===email && u.password===password);
  if(user){
    localStorage.setItem('loggedInUser',username);
    document.body.classList.add('logged-in');
    showMainContent();
    populateRecipients();
    showChatMessages();
  } else alert('Invalid credentials.');
}

function logout() {
  localStorage.removeItem('loggedInUser');
  document.body.classList.remove('logged-in');
  document.getElementById('mainContent').classList.add('hidden');
  showLogin();
}

function showMainContent() {
  document.getElementById('signupForm').classList.add('hidden');
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
}

function showLogin() { 
  document.getElementById('signupForm').classList.add('hidden'); 
  document.getElementById('loginForm').classList.remove('hidden'); 
}

function showSignup() { 
  document.getElementById('loginForm').classList.add('hidden'); 
  document.getElementById('signupForm').classList.remove('hidden'); 
}

// Chat functions
function getTimestamp() {
  const now = new Date();
  return now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
}

function populateRecipients() {
  const recipientSelect = document.getElementById('chatRecipient');
  recipientSelect.innerHTML = '<option value="">Select a user...</option>';
  users.forEach(u=>{
    if(u.username !== localStorage.getItem('loggedInUser')){
      const opt = document.createElement('option');
      opt.value = u.username;
      opt.textContent = u.username;
      recipientSelect.appendChild(opt);
    }
  });
}

function showChatMessages() {
  const chatDiv = document.getElementById('chatMessages');
  const loggedIn = localStorage.getItem('loggedInUser');
  const recipient = document.getElementById('chatRecipient').value;
  chatDiv.innerHTML = '';
  if(!recipient) return;
  messages
    .filter(m => (m.from===loggedIn && m.to===recipient) || (m.from===recipient && m.to===loggedIn))
    .forEach(m=>{
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chatMessage ' + (m.from===loggedIn?'sent':'received');
      msgDiv.innerHTML = m.text + '<span class="timestamp">['+m.timestamp+']</span>';
      chatDiv.appendChild(msgDiv);
    });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  const loggedIn = localStorage.getItem('loggedInUser');
  const recipient = document.getElementById('chatRecipient').value;
  if(!text || !recipient) return alert('Select a recipient and type a message');
  messages.push({ from: loggedIn, to: recipient, text, timestamp:getTimestamp() });
  localStorage.setItem('messages',JSON.stringify(messages));
  input.value = '';
  showChatMessages();
}

// Live-update across tabs
window.addEventListener('storage', (event) => {
  if(event.key === 'messages'){
    messages = JSON.parse(event.newValue) || [];
    showChatMessages();
  }
});
</script>
</body>
</html>
